#!/usr/bin/env bash

TARGET=$1
SLUG=$2

usage() {
    echo
    echo "  link.bsmnt.pro â€” a serverless & minimalist URL shortener that doesn't try to do too much."
    echo
    echo "  usage:"
    echo
    echo "      ./generate <url to redirect> <slug>"
    echo
    echo "  example:"
    echo
    echo "      ./generate https://github.com/basement-works github -- will redirect /github to https://github.com/basement-works"
    echo "      ./generate https://github.com/basement-works/link.bsmnt.pro -- will redirect /<auto-generated> to https://github.com/basement-works/link.bsmnt.pro"
    echo
    echo "  notes:"
    echo "      auto-generated slug only can be use if you have openssl(1) installed on your machine"
}

# if there is no argument, show usage
if [ -z "$TARGET" ]; then
    usage
    exit 1
fi

# if the argument is only 1
if [ -z "$SLUG" ]; then
    # and openssl is not installed, show error message
    if ! command -v openssl &> /dev/null; then
        echo
        echo "  in order to use auto-generated slug, you need to have openssl(1) installed on your machine"
        exit 1
    fi

    # otherwise, generate random string
    SLUG=$(openssl rand -hex 3)
fi

# check is the slug exists?
if [ -f "links/$SLUG.md" ]; then
    echo
    echo "/$SLUG is already exist. please choose another"
    echo
    exit 1
fi

# create new file & the content
cat << EOF > links/$SLUG.md
---
target: $TARGET
---
EOF

# move that file to staging area
git add links/$SLUG.md
git commit -m "feat: create /$SLUG" -m "url target is $TARGET" > /dev/null 2>&1

# done
echo
echo "  successfully creating redirect from /$SLUG to $TARGET"serverless